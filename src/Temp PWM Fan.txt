#include <Arduino.h>
#include <U8g2lib.h>
#include <math.h> // Nodig voor log() berekening

// --- PIN DEFINITIES ---
const int ntcPin = 1;         
const int fanPwmPin = 10;     
const int fanTachoPin = 2;    

// --- NTC & DIVIDER PARAMETERS ---
const float seriesResistor = 10000;    // Vaste weerstand van 10k
const float nominalResistance = 10000; // NTC weerstand bij 25 graden
const float nominalTemperature = 25;   // Nominale temp in Celsius
const float bCoefficient = 3950;       // Beta-waarde van de meeste 10k NTC's
const float adcMax = 4095.0;           // 12-bit ADC resolutie van de C3

// --- PWM INSTELLINGEN ---
const int pwmFreq = 25000;
const int pwmRes = 10;
const int pwmChannel = 0;

// --- TACHOMETER & VARIABELEN ---
volatile int pulseCount = 0;
unsigned long lastMillis = 0;
int currentRPM = 0;
void IRAM_ATTR countPulses() { pulseCount++; }

U8G2_SSD1306_128X64_NONAME_F_HW_I2C u8g2(U8G2_R0, U8X8_PIN_NONE);

// Functie om ADC waarde naar Celsius om te rekenen
float calculateCelsius(int rawADC) {
  if (rawADC <= 0) return 0;
  // Bereken weerstand van de NTC
  float resistance = seriesResistor / (adcMax / (float)rawADC - 1.0);
  
  // Steinhart-Hart formule (B-parameter vergelijking)
  float steinhart;
  steinhart = resistance / nominalResistance;     // (R/Ro)
  steinhart = log(steinhart);                      // ln(R/Ro)
  steinhart /= bCoefficient;                       // 1/B * ln(R/Ro)
  steinhart += 1.0 / (nominalTemperature + 273.15); // + (1/To)
  steinhart = 1.0 / steinhart;                     // Inverteer naar Kelvin
  steinhart -= 273.15;                             // Kelvin naar Celsius
  return steinhart;
}

void setup() {
  Serial.begin(115200);
  u8g2.begin();
  u8g2.enableUTF8Print(); // Zorgt dat we het graden-symbool (°) kunnen printen

  ledcSetup(pwmChannel, pwmFreq, pwmRes);
  ledcAttachPin(fanPwmPin, pwmChannel);

  pinMode(fanTachoPin, INPUT_PULLUP);
  attachInterrupt(digitalPinToInterrupt(fanTachoPin), countPulses, FALLING);
}

void loop() {
  int rawADC = analogRead(ntcPin);
  float tempC = calculateCelsius(rawADC);

  // Aansturing (ADC): Warmer = lagere ADC = hogere PWM
  int fanDuty = map(rawADC, 2200, 1200, 0, 1023); 
  fanDuty = constrain(fanDuty, 0, 1023);
  ledcWrite(pwmChannel, fanDuty);

  // RPM berekening
  if (millis() - lastMillis >= 1000) {
    noInterrupts();
    currentRPM = (pulseCount / 2.0) * 60.0;
    pulseCount = 0;
    interrupts();
    lastMillis = millis();
  }

  // SCHERM UPDATEN
  u8g2.clearBuffer();
  
  // Header
  u8g2.setFont(u8g2_font_6x12_tr);
  u8g2.drawStr(0, 10, "RADIATOR MONITOR");
  u8g2.drawLine(0, 13, 128, 13);

  // Grote Temperatuur Weergave
  u8g2.setFont(u8g2_font_helvB18_tf);
  u8g2.setCursor(0, 40);
  u8g2.print(tempC, 1); // Toon 1 decimaal
  u8g2.print("°C");      // Dankzij enableUTF8Print()

  // RPM Rechtsboven
  u8g2.setFont(u8g2_font_6x10_tr);
  u8g2.setCursor(80, 28);
  u8g2.print(currentRPM);
  u8g2.setCursor(80, 40);
  u8g2.print("RPM");

  // PWM Balk onderin
  int pwmPercent = map(fanDuty, 0, 1023, 0, 100);
  u8g2.drawFrame(0, 56, 128, 8);
  u8g2.drawBox(2, 58, map(pwmPercent, 0, 100, 0, 124), 4);
  u8g2.setFont(u8g2_font_4x6_tr);
  u8g2.drawStr(0, 53, "FAN POWER:");
  u8g2.setCursor(110, 53); u8g2.print(pwmPercent); u8g2.print("%");

  u8g2.sendBuffer();
  delay(200);
}
